# Интеграция Simpla -> RetailCRM #
Экспорт клиентов и заказов из интернет-магазина Simpla в RetailCRM. Формирование ICML документа для RetailCRM (все товары и их свойства в XML виде определённой структуры). Скрипты используют v3 версию API RetailCRM. Проверено на работе Simpla версии 2.3.7

## Установка ##
1. Установить Simpla
2. Скопировать два скрипта *export_orders_retailCRM.php* и *export_to_ICML_retailCRM.php* в каталог web-сервера /simpla/ajax/
3. Создать в корне web-сервера иерархию каталогов:
/integration
|----/log
|----/icml
Каталоги log и icml должны быть доступны для записи криптам php. В каталоге /integration/log/ будут располагаться лог-файлы по работе скриптов экспорта. В каталоге /integration/icml/ будет записываться ICML файл.
4. Скопировать в каталог /integration файлы config.php, icml.php, orders.php, Tools.php 
5. В файле config.php прописать собственные значения настроек в соответствии с комментариями.
6. ОПЦИОНАЛЬНО. Заменить родной файл Simpla /simpla/design/html/export.tpl на его модифицированный вариант - только если требуется запускать представленные скрипты экспорта вручную из административной панели сайта интернет-магазина. Новые кнопки появятся в админке: Автоматизация/Экспорт.
7. Установить официальный клиент для работы с API RetailCRM (https://github.com/retailcrm/api-client-php). Скрипты будут расположены в каталоге */vendor/retailcrm/api-client-php/lib/RetailCrm/*

## Использование ##
Запуск экспорта можно производить различными способами: автоматически и вручную.

Запуск экспорта товаров можно производить вручную через административную панель сайта (для этого понадобится войти под учётной записью с правами экспорта - учётная запись администратора обладает необходимыми правами). Перейти в раздел Автоматизация/Экспорт. Первая кнопка - это стандартный экспорт из поставки Simpla. 
Вторая кнопка - добавленный экспорт клиентов и заказов напрямую на сайт RetailCRM. Если операцию выполнять впервые, то будет произведён экспорт всех существующих заказов и клиентов по этим заказам. После выгрузки данных будет сформирован файл в каталоге web-сервера /integration/log/history.log с отметкой времени последней выгрузки. Все последующие попытки экспорта будут формироваться по заказам, созданным в Simpla позже указанной метки (метка обновляется после каждой успешной выгрузки).
Третья кнопка запускает формирование ICML (https://www.retailcrm.ru/docs/%D0%A0%D0%B0%D0%B7%D1%80%D0%B0%D0%B1%D0%BE%D1%82%D1%87%D0%B8%D0%BA%D0%B8/%D0%A4%D0%BE%D1%80%D0%BC%D0%B0%D1%82ICML) файла /vendor/integration/icml.xml

Запуск экспорта заказов и клиентов можно производить вручную через консоль операционной системы (если путь к php определён в окружении):
```bash
php /<путь к HTTP серверу>/simpla/ajax/export_orders_retailCRM.php 
```
Запуск формирования ICML файла
```bash
php /<путь к HTTP серверу>/simpla/ajax/export_to_ICML_retailCRM.php
```
Дополнительные параметры не требуются. Ответ будет показан в консоли. Если ответ не требуется, то вывод команд нужно перенаправить:
```bash
php /<путь к HTTP серверу>/simpla/ajax/export_orders_retailCRM.php >/dev/null 2>&1
php /<путь к HTTP серверу>/simpla/ajax/export_to_ICML_retailCRM.php >/dev/null 2>&1
```
В любом случае процесс работы скриптов будет отражён в логах в каталоге web-сервера /integration/log/

Запуск скриптов на Linux сервере можно настроить на регулярное выполнение с помощью cron. Например, для выполненния каждые 15 минут скрипта export_orders_retailCRM.php, нужно в файл /etc/crontab дописать строку:
```bash
*/15 * * * * www-data	/usr/bin/php5 /<путь к HTTP серверу>/simpla/ajax/export_orders_retailCRM.php >/dev/null 2>&1
```
После перезапуска cron скрипт будет выполняться каждые 15 минут. Результат работы задания можно увидеть в системном логе /var/log/syslog Результат работы скрипта в логах в каталоге web-сервера /integration/log/ В приведённом примере скрипт запускается от имени пользователя www-data (пользователь Apache по-умолчанию в Linux дистрибутивах семейства Debian), - при необходимости изменить на текущего пользователя, от имени которого работает web-сервер.

Возможно настроить автомарический запуск скриптов после оформления каждого нового заказа. В Simpla есть возможность автоматической отправки письма на почту после оформления заказа. На стороне почтового сервера возможно настроить обработку входящих писем. При получении письма, сигнализирующего о новом заказе, запускать скрипт (некоторые почтовые сервисы позволяют это делать).
